name: manual-hexo-build

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Run test build (no publish) or deploy?"
        required: true
        default: "test"
        type: choice
        options:
          - test
          - deploy
      lang:
        description: "Which language site?"
        required: true
        default: "zh"
        type: choice
        options:
          - zh
          - en

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18.16.1"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm install

      - name: Select config for chosen lang
        run: |
          cp "config-${{ github.event.inputs.lang }}.yml" _config.yml
          cp "config-butterfly-${{ github.event.inputs.lang }}.yml" "_config.butterfly.yml"
          echo "Using language=${{ github.event.inputs.lang }}"
          echo "Final _config.yml (first 40 lines):"
          head -n 40 _config.yml

      #######################################################
      # TEST MODE
      #######################################################

      - name: Generate static site (test mode)
        if: ${{ github.event.inputs.mode == 'test' }}
        run: |
          npx hexo clean
          npx hexo g
          echo "Hexo generate complete."
          ls -al

      - name: Upload preview artifact (zh)
        if: ${{ github.event.inputs.mode == 'test' && github.event.inputs.lang == 'zh' }}
        uses: actions/upload-artifact@v4
        with:
          name: "preview-zh"
          path: public
          retention-days: 7

      - name: Upload preview artifact (en)
        if: ${{ github.event.inputs.mode == 'test' && github.event.inputs.lang == 'en' }}
        uses: actions/upload-artifact@v4
        with:
          name: "preview-en"
          path: public-en
          retention-days: 7

      #######################################################
      # DEPLOY MODE: ZH
      #######################################################

      - name: Configure git credential for zh deploy
        if: ${{ github.event.inputs.mode == 'deploy' && github.event.inputs.lang == 'zh' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Deploying zh -> same repo branch 'deploy' using GITHUB_TOKEN"

          # 全域 user name / email，給 .deploy_git 裡的 commit 用
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 全域 credential helper，讓任何新 init 的 repo 也能讀到
          git config --global credential.helper store

          # 在 runner 建立憑證：push https://github.com/leozzmc/leozzmc.github.io.git 時用 GITHUB_TOKEN
          echo "https://${GITHUB_TOKEN}:@github.com/leozzmc/leozzmc.github.io.git" > ~/.git-credentials

          echo "---- deploy section from _config.yml ----"
          grep -A4 "^deploy" _config.yml || true
          echo "-----------------------------------------"

      - name: Build & Deploy zh (hexo deploy)
        if: ${{ github.event.inputs.mode == 'deploy' && github.event.inputs.lang == 'zh' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Running zh deploy..."
          npm run kk
          echo "ZH Deploy done."

      - name: Upload deployed zh artifact
        if: ${{ github.event.inputs.mode == 'deploy' && github.event.inputs.lang == 'zh' }}
        uses: actions/upload-artifact@v4
        with:
          name: "deployed-zh"
          path: public
          retention-days: 7

      #######################################################
      # DEPLOY MODE: EN
      #######################################################

      - name: Configure git credential for en deploy
        if: ${{ github.event.inputs.mode == 'deploy' && github.event.inputs.lang == 'en' }}
        env:
          EN_REPO_TOKEN: ${{ secrets.EN_REPO_TOKEN }}
        run: |
          echo "Deploying en -> external repo leozzmc/en using EN_REPO_TOKEN"

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git config --global credential.helper store
          echo "https://${EN_REPO_TOKEN}:@github.com/leozzmc/en.git" > ~/.git-credentials

          echo "---- deploy section from _config.yml ----"
          grep -A4 "^deploy" _config.yml || true
          echo "-----------------------------------------"

      - name: Build & Deploy en (hexo deploy)
        if: ${{ github.event.inputs.mode == 'deploy' && github.event.inputs.lang == 'en' }}
        env:
          EN_REPO_TOKEN: ${{ secrets.EN_REPO_TOKEN }}
        run: |
          echo "Running en deploy..."
          npm run kk
          echo "EN Deploy done."

      - name: Upload deployed en artifact
        if: ${{ github.event.inputs.mode == 'deploy' && github.event.inputs.lang == 'en' }}
        uses: actions/upload-artifact@v4
        with:
          name: "deployed-en"
          path: public-en
          retention-days: 7
